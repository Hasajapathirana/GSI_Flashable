name: Build GSI

on:
  workflow_dispatch:
    inputs:
      download_url:
        description: 'URL to download the .xz file'
        required: true
        default: https://github.com/ChonDoit/treble_crdroid_patches/releases/download/A13-Signed/Crdroid_A13-arm64-bvS_20240701.img.xz
      gsi_rom_name:
        description: 'Name of the GSI ROM'
        required: true
        default: CrDroid-BVS

permissions:
  contents: write

jobs:
  Download_and_build_gsi:
    runs-on: windows-latest

    steps:
      - name: Set up the repository
        uses: actions/checkout@v3

      - name: Install Git LFS
        run: |
          git lfs install

      - name: Download 7zip
        run: |
          choco install wget
          wget https://www.7-zip.org/a/7z2301-x64.exe -O 7zip_installer.exe
          ./7zip_installer.exe /S

      - name: Download the .xz
        run: |
          $url = '${{ github.event.inputs.download_url }}'
          $output = 'system.img.xz'
          curl -L $url -o $output

      - name: Extract the .xz file using tar
        run: |
          7z e system.img.xz
          ls

      - name: Rename system.img to system.img.ext4
        run: |
          Rename-Item -Path 'system.img' -NewName 'system.img.ext4'
          ls

      - name: Compress to Odin flashable
        run: |
          7z a -ttar "${{ github.event.inputs.gsi_rom_name }}-GSI.tar" system.img.ext4 vbmeta.img

      - name: Upload large file with Git LFS
        run: |
          git lfs track "${{ github.event.inputs.gsi_rom_name }}-GSI.tar" # Track the tar file
          git add .gitattributes
          git add "${{ github.event.inputs.gsi_rom_name }}-GSI.tar" # Add the tar file
          git commit -m "Add large GSI tar file using LFS"
          git push origin main # Push changes to the main branch
