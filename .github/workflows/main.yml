name: Build GSI

on:
  workflow_dispatch:
    inputs:
      download_url:
        description: 'URL to download the .xz file'
        required: true
        default: 'https://example.com/path/to/file.xz'
      gsi_rom_name:
        description: 'Name of the GSI ROM'
        required: true
        default: 'CustomGSI'


jobs:
   Download_and_build_gsi :
    runs-on: windows-latest

    steps:
      - name: Set up the repository
        uses: actions/checkout@v3
 
      - name: Download 7zip 
        run: |
           choco install wget
           wget https://www.7-zip.org/a/7z2301-x64.exe -O 7zip_installer.exe
           ./7zip_installer.exe /S         

      - name: Download the .xz 
        run: |
          $url = '${{ github.event.inputs.download_url }}'
          $output = 'system.img.xz'
          curl -L $url -o $output
          if (Test-Path 'system.img.xz') {
            $fileSize = (Get-Item $output).length
            Write-Host "Downloaded $url to $output. File size: $fileSize bytes."
          } else {
            Write-Host "Error: Download failed or file not found."
            exit 1
          }

      - name: Extract the .xz file using tar
        run: |
           ls
           7z e system.img.xz
           ls  

      - name: Rename system.img to system.img.ext4
        run: |
            ls
            Rename-Item -Path 'system.img' -NewName 'system.img.ext4'
            ls
            
      - name: Copy lz4 and md5 folders to the home directory
        run: |
          cp system.img.ext4 "$HOME\tar-md5-script-tool\"
          cd tar-md5-script-tool 
          ls

      - name: Compress vbmeta.img to vbmeta.img.lz4
        run: |
          cd lz4
          ./lz4.exe -B6 --content-size vbmeta.img vbmeta.img.lz4
          Write-Host "Compressed vbmeta.img to vbmeta.img.lz4."

      - name: Compress system.img.ext4 to system.img.ext4.lz4
        run: |
          cd lz4
          ./lz4.exe -B6 --content-size system.img.ext4 system.img.ext4.lz4
          Write-Host "Compressed system.img.ext4 to system.img.ext4.lz4."

      - name: Copy compressed files to md5 directory
        run: |
          cp "$HOME\lz4\system.img.ext4.lz4" "$HOME\tar-md5-script-tool"
          cp "$HOME\lz4\vbmeta.img.lz4" "$HOME\tar-md5-script-tool"
          cd tar-md5-script-tool 
          ls
          


      - name: Run batch.bat in the md5 directory
        run: |
          cd tar-md5-script-tool
          ./batch.bat
          Write-Host "Executed batch.bat in the md5 directory."

      - name: Release recovery
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.run_id }}
          name: ${{ github.event.inputs.gsi_rom_name }} GSI
          files: |
            $HOME/tar-md5-script-tool/AP_TAR_MD5_CUSTOM_FILE_ODIN.tar.md5
